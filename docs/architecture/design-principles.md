# 设计原则与技术取舍

本文总结 PyVideoTrans 在音视频翻译与配音场景下采用的关键设计原则与工程取舍，帮助读者在二次开发与扩展时保持一致性。

## 总体目标
- 端到端稳定：识别 → 翻译 → 配音 → 合成链路可观测、可恢复
- 可扩展：便捷新增识别/翻译/TTS 渠道与本地模型
- 跨平台：兼容 Windows/macOS/Linux，充分利用 GPU/MPS
- 易运维：产物与日志结构清晰，便于定位问题

## 架构原则
1. 单一职责与分层
   - `videotrans/task` 负责任务调度与阶段编排
   - 识别/翻译/TTS 的具体实现位于各自适配层，解耦渠道差异
2. 队列驱动与幂等
   - 阶段之间通过队列与中间产物衔接，失败可重试
   - 任务目录 `apidata/<task_id>/` 作为事实来源（Source of Truth）
3. 可观测性优先
   - 统一的阶段日志写入 `processinfo/<task_id>.json`
   - GUI 与 API 共享同一套状态与产物约定
4. 约束显式化
   - 语言/渠道能力边界通过 `is_allow_lang`、`is_input_api` 明确定义
   - 大模型/第三方服务的速率与超时在配置中可控

## 性能与资源策略
- 模型选择：优先 small/medium 兼顾速度与质量；追求极致用 large-v3/GPU
- 并发：根据 CPU/GPU 资源调节并发度，避免过度并行导致抖动
- 缓存：模型与音频中间件可缓存；定期清理临时目录与过期产物

## 错误处理与重试
- 阶段失败不影响已就绪产物，允许从中间阶段恢复
- 第三方 API 失败采用指数退避或降级至备用渠道
- 文件/编码异常优先转换为标准容器（H.264 + AAC）再处理

## 可扩展点清单
- 新增识别渠道：实现对应适配器并注册到 `recognition/__init__.py`
- 新增翻译渠道：实现接口并在 `translator/__init__.py` 登记与语言映射
- 新增 TTS 渠道：实现接口并在 `tts/__init__.py` 注册，支持语速/音量/音调

## 安全与合规
- API Key 通过 GUI/配置安全存储，不写入日志
- 网络调用遵守速率限制与服务条款
- 本地缓存与导出目录遵循用户可见与可清理原则

---

配合《架构文档规划》《源码导读规划》，此文档将持续补充示意图与典型调用链说明。